---
phase: 02-publishing
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/publisher/publisher.go
  - internal/publisher/publisher_test.go
autonomous: true
requirements:
  - PUB-01
  - PUB-02
  - PUB-04

must_haves:
  truths:
    - "WriteManifests creates .claude-plugin/marketplace.json and per-skill plugin.json files"
    - "DiffManifests returns new/modified/unchanged status for each file without writing anything"
    - "CheckFreshness detects when skill source files are newer than published plugin.json"
    - "Version bumps patch number when existing plugin.json has a version"
    - "Version defaults to 0.1.0 when no published plugin.json exists"
  artifacts:
    - path: "internal/publisher/publisher.go"
      provides: "WriteManifests, DiffManifests, CheckFreshness, bumpVersion functions"
      min_lines: 100
    - path: "internal/publisher/publisher_test.go"
      provides: "Tests for write, diff, freshness, and version bump"
      min_lines: 80
  key_links:
    - from: "internal/publisher/publisher.go"
      to: "internal/generator/generator.go"
      via: "GeneratePluginJSON and GenerateMarketplaceJSON calls"
      pattern: "generator\\.Generate"
    - from: "internal/publisher/publisher.go"
      to: "internal/config/config.go"
      via: "Org and Skill types"
      pattern: "config\\.(Org|Skill)"
---

<objective>
Build the publisher package with filesystem-only operations: write manifests to disk, produce diff previews, check staleness, and bump versions.

Purpose: Separate testable filesystem logic from git operations. This package does everything except commit and push.
Output: `internal/publisher/publisher.go` and `internal/publisher/publisher_test.go` with full coverage of PUB-01, PUB-02, and PUB-04.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-publishing/02-RESEARCH.md
@internal/generator/generator.go
@internal/config/config.go
@internal/discovery/discovery.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create publisher package with TDD</name>
  <files>internal/publisher/publisher.go, internal/publisher/publisher_test.go</files>
  <action>
Create `internal/publisher/publisher.go` and `internal/publisher/publisher_test.go` using RED-GREEN-REFACTOR.

**Types to define:**

```go
type WrittenFile struct {
    Path    string // relative to brand repo root
    IsNew   bool   // true if file didn't exist before
}

type FileChange struct {
    Path       string // relative to brand repo root
    Kind       string // "new", "modified", "unchanged"
    OldContent string
    NewContent string
}

type FreshnessResult struct {
    Skill            string
    Stale            bool
    PublishedVersion string // "" if not yet published
}
```

**Functions to implement:**

1. `bumpVersion(brandRepoPath, skillsDir, skillName string) string` — Read existing `plugin.json` from `<brandRepoPath>/<skillsDir>/<skillName>/plugin.json`. Parse version with `fmt.Sscanf("%d.%d.%d")`. Return `major.minor.(patch+1)`. Return `"0.1.0"` if file missing, unparseable, or no version field.

2. `WriteManifests(org config.Org, skills []config.Skill) ([]WrittenFile, error)` — For each skill: call `generator.GeneratePluginJSON(skill)` to get content, call `bumpVersion` to get the next version, replace the version field in the generated JSON (unmarshal, set version, re-marshal), write to `<skill.Path>/plugin.json`. Then call `generator.GenerateMarketplaceJSON(org, skills)`, similarly bump each plugin version, write to `<org.Path>/<org.BrandRepo>/.claude-plugin/marketplace.json`. Create directories with `os.MkdirAll`. Return list of `WrittenFile` with `IsNew` set based on whether file existed before writing. Before overwriting any existing `plugin.json`, check if it was generated by chaparral (contains `"skills": "./"` field) — if not, return an error for that skill with a message like `"plugin.json exists and was not generated by chaparral — skipping <skill.Name>"`. Skip that skill but continue with others.

3. `DiffManifests(org config.Org, skills []config.Skill) ([]FileChange, error)` — Same generation logic as WriteManifests but read-only. For each file that would be written: if not exists, `Kind = "new"`. If exists and content differs, `Kind = "modified"` with both old and new content. If identical, `Kind = "unchanged"`. Uses `bumpVersion` for the same version that WriteManifests would use.

4. `CheckFreshness(org config.Org, skills []config.Skill) ([]FreshnessResult, error)` — For each skill: stat `<skill.Path>/plugin.json`. If not exists, report as stale with empty `PublishedVersion`. If exists, compare `ModTime()` of the published `plugin.json` against all files in the skill directory (excluding `plugin.json` itself). If any skill file is newer, `Stale = true`. When mtimes are within 1 second (post-clone scenario), fall back to content comparison: generate what the plugin.json would be, compare to existing. Read version from existing `plugin.json` for the `PublishedVersion` field.

**Test approach (TDD):**

Write tests first for each function using `t.TempDir()` to create isolated test filesystems:

- `TestBumpVersion_NoExistingFile` — returns "0.1.0"
- `TestBumpVersion_ExistingVersion` — write a plugin.json with version "0.1.2", expect "0.1.3"
- `TestBumpVersion_MalformedJSON` — returns "0.1.0"
- `TestWriteManifests_NewFiles` — verify files created, IsNew=true
- `TestWriteManifests_ExistingFiles` — verify overwrite, IsNew=false
- `TestWriteManifests_NonChaparralPluginJSON` — verify skip + error message
- `TestDiffManifests_NewFiles` — all Kind="new"
- `TestDiffManifests_ModifiedFiles` — write first, change skill, Kind="modified"
- `TestDiffManifests_UnchangedFiles` — write then diff again, Kind="unchanged"
- `TestCheckFreshness_NeverPublished` — Stale=true, PublishedVersion=""
- `TestCheckFreshness_Stale` — touch skill file after plugin.json, Stale=true
- `TestCheckFreshness_Fresh` — write plugin.json after skill files, Stale=false

Tests need to create valid SKILL.md frontmatter files in temp dirs so that `generator.GeneratePluginJSON` works. Use this minimal SKILL.md:
```
---
name: test-skill
description: a test skill
---
# Test
```

The config.Org and config.Skill structs should be populated to point at the temp directory paths.

Run tests: `go test ./internal/publisher/ -v`
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/chaparral && go test ./internal/publisher/ -v -count=1</automated>
    <manual>Check that publisher.go has WriteManifests, DiffManifests, CheckFreshness, bumpVersion</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All publisher tests pass. WriteManifests creates .claude-plugin/ directory and per-skill plugin.json files. DiffManifests produces file change reports without writing. CheckFreshness detects stale skills. Version bumps correctly.</done>
</task>

</tasks>

<verification>
- `go test ./internal/publisher/ -v` — all tests pass
- `go vet ./internal/publisher/` — no issues
- `go build ./cmd/chaparral` — still compiles (publisher not wired yet, but package compiles)
</verification>

<success_criteria>
- Publisher package exists with four exported functions and one unexported helper
- All tests pass covering new files, existing files, staleness, and version bumping
- No non-chaparral files are overwritten without warning
- Version bump reads from existing published plugin.json and increments patch
</success_criteria>

<output>
After completion, create `.planning/phases/02-publishing/02-01-SUMMARY.md`
</output>
