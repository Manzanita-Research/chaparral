---
phase: 02-publishing
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - internal/publisher/git.go
  - internal/publisher/git_test.go
  - cmd/chaparral/main.go
  - go.mod
  - go.sum
autonomous: true
requirements:
  - PUB-03
  - PUB-01
  - PUB-02
  - PUB-04

must_haves:
  truths:
    - "User can run `chaparral publish --check` to see staleness report"
    - "User can run `chaparral publish --write-only` to write manifests without pushing"
    - "User can run `chaparral publish` and see diff preview, then two-step confirmation before push"
    - "Push requires GITHUB_TOKEN env var and shows clear message if missing"
    - "Second publish with no changes prints 'already up to date' instead of erroring"
  artifacts:
    - path: "internal/publisher/git.go"
      provides: "CommitAndPush function using go-git v5"
      min_lines: 40
    - path: "internal/publisher/git_test.go"
      provides: "Tests for git commit and no-changes handling"
      min_lines: 30
    - path: "cmd/chaparral/main.go"
      provides: "publish command with --check, --write-only flags and two-step confirmation"
      contains: "runPublish"
  key_links:
    - from: "cmd/chaparral/main.go"
      to: "internal/publisher/publisher.go"
      via: "CheckFreshness, DiffManifests, WriteManifests calls"
      pattern: "publisher\\.(Check|Diff|Write)"
    - from: "cmd/chaparral/main.go"
      to: "internal/publisher/git.go"
      via: "CommitAndPush call after two-step confirmation"
      pattern: "publisher\\.CommitAndPush"
    - from: "internal/publisher/git.go"
      to: "go-git/go-git/v5"
      via: "PlainOpen, Worktree, Add, Commit, Push"
      pattern: "git\\.Plain"
---

<objective>
Add go-git integration for commit+push and wire the `chaparral publish` CLI command with three modes: staleness check, write-only, and full publish with two-step confirmation.

Purpose: Complete the publishing pipeline from filesystem writes through to GitHub push, with safety rails at every step.
Output: `internal/publisher/git.go`, updated `cmd/chaparral/main.go`, go-git dependency added.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-publishing/02-RESEARCH.md
@.planning/phases/02-publishing/02-01-SUMMARY.md
@internal/publisher/publisher.go
@internal/generator/generator.go
@internal/config/config.go
@cmd/chaparral/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add go-git dependency and create git operations</name>
  <files>internal/publisher/git.go, internal/publisher/git_test.go, go.mod, go.sum</files>
  <action>
Run `go get github.com/go-git/go-git/v5` to add the dependency.

Create `internal/publisher/git.go` with:

```go
package publisher

// CommitAndPush stages .claude-plugin/ and skill plugin.json files,
// commits with a structured message, and pushes to origin.
func CommitAndPush(brandRepoPath string, writtenFiles []WrittenFile, version string) error
```

Implementation:
1. `git.PlainOpen(brandRepoPath)` to open the brand repo
2. Get worktree with `repo.Worktree()`
3. Stage each file from `writtenFiles` using `w.Add(file.Path)` — paths are relative to repo root
4. Also stage `".claude-plugin/marketplace.json"` explicitly
5. Commit with message `fmt.Sprintf("publish marketplace v%s", version)` and author `object.Signature{Name: "chaparral", Email: "chaparral@local", When: time.Now()}`
6. Check for `git.ErrNoChanges` — if so, return a custom `ErrNoChanges` sentinel error (not go-git's internal one) so the caller can print "already up to date" instead of erroring
7. Push with `git.PushOptions{RemoteName: "origin"}` using HTTPS BasicAuth:
   - Read `GITHUB_TOKEN` from `os.Getenv("GITHUB_TOKEN")`
   - If empty, return `fmt.Errorf("GITHUB_TOKEN is not set — needed to push to GitHub")`
   - Auth: `&githttp.BasicAuth{Username: "token", Password: token}`
8. Check for `git.NoErrAlreadyUpToDate` on push — treat as success

Also add a helper:
```go
// RemoteURL returns the origin remote URL for display in confirmation prompts.
func RemoteURL(brandRepoPath string) (string, error)
```
Uses `repo.Remote("origin").Config().URLs[0]`.

Create `internal/publisher/git_test.go` with:
- `TestCommitAndPush_NoChanges` — init a bare repo + clone, commit once, call CommitAndPush with same files → expect ErrNoChanges sentinel
- Use `git.PlainInit` to create test repos in `t.TempDir()`
- Do NOT test actual push (requires network) — test staging and commit only

Run: `go test ./internal/publisher/ -v`
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/chaparral && go test ./internal/publisher/ -v -count=1</automated>
    <manual>Check go.mod includes go-git/go-git/v5</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>go-git dependency added. CommitAndPush stages files, commits, and pushes. ErrNoChanges handled gracefully. RemoteURL reads origin URL. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Wire chaparral publish command with three modes</name>
  <files>cmd/chaparral/main.go</files>
  <action>
Add the `publish` command to `cmd/chaparral/main.go`.

**1. Add to switch statement:**
```go
case "publish":
    runPublish(basePath)
```

**2. Implement `runPublish(basePath string)`:**

Parse flags from `os.Args[2:]`:
- `--check`: staleness report only, no writes, no push
- `--write-only`: write manifests, no git operations

**--check mode (PUB-04):**
```
For each org:
  Call publisher.CheckFreshness(org, skills)
  Print each skill: "✓ skill-name (v0.1.2)" if fresh, "○ skill-name (stale)" if stale
  Print summary: "N of M skills are up to date"
```

**--write-only mode (PUB-01 + PUB-02):**
```
For each org:
  Call publisher.DiffManifests(org, skills) — show preview
  Print each change: "+ path (new)" or "~ path (modified)" or "  path (unchanged)"
  If all unchanged: print "nothing to write" and continue
  Call publisher.WriteManifests(org, skills)
  Print summary: "wrote N files"
```

**Default mode — full publish (PUB-01 + PUB-02 + PUB-03):**
```
For each org:
  1. Call publisher.DiffManifests(org, skills) — show preview
     Print each change with +/~/space prefix
     If all unchanged: print "already up to date — nothing to publish" and continue

  2. Get version (call bumpVersion for the first skill to get the next version —
     or better: extract from the DiffManifests NewContent by parsing the JSON)

  3. Get remote URL: publisher.RemoteURL(brandRepoPath)

  4. Print confirmation summary:
     "Publish marketplace v{version} to {remoteURL}?"
     "Files to write: {count}"
     ""
     First prompt: "Push to GitHub? [y/N] "
     Read stdin. If not "y", print "cancelled." and return.

  5. Second prompt: "Confirm push (this will update the live marketplace): [y/N] "
     Read stdin. If not "y", print "cancelled." and return.

  6. Call publisher.WriteManifests(org, skills)
  7. Call publisher.CommitAndPush(brandRepoPath, writtenFiles, version)
     - If ErrNoChanges: print "already up to date"
     - If other error: print error and continue
  8. Print "published v{version} to {remoteURL}"
```

**3. Add `confirm(prompt string) bool` helper** — uses `bufio.NewReader(os.Stdin)` to read a line, returns true if trimmed lowercase input equals "y".

**4. Update `printHelp()`** — add:
```
  chaparral publish    write manifests and push marketplace to GitHub
    --check            check if local skills are newer than published
    --write-only       write manifests without pushing to GitHub
```

**5. Add import** for `"bufio"` and `"github.com/manzanita-research/chaparral/internal/publisher"`.

Keep the same output style as existing commands — org name first, indented details underneath, summary at the end.
  </action>
  <verify>
    <automated>cd /Users/jem/code/manzanita-research/chaparral && go build ./cmd/chaparral && go vet ./...</automated>
    <manual>Run `./chaparral help` and verify publish command appears. Run `./chaparral publish --check` against a real brand repo to verify staleness output.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>`chaparral publish` command works with three modes: --check shows staleness, --write-only writes without push, default shows diff preview and two-step confirmation before commit+push. Help text updated.</done>
</task>

</tasks>

<verification>
- `go test ./internal/publisher/ -v` — all tests pass (including git tests)
- `go build ./cmd/chaparral` — compiles successfully
- `go vet ./...` — no issues
- `./chaparral help` — shows publish command with --check and --write-only flags
- `./chaparral publish --check` — shows staleness report for discovered orgs
</verification>

<success_criteria>
- `chaparral publish --check` reports staleness per skill per org
- `chaparral publish --write-only` writes manifests and shows what was written
- `chaparral publish` shows diff, prompts twice, commits, and pushes
- Missing GITHUB_TOKEN produces a clear message
- Second publish with no changes says "already up to date"
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-publishing/02-02-SUMMARY.md`
</output>
